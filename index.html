<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Savings 2025</title>
  <style>
    :root {
      --bg: #0b0f17; /* azul-escuro quase preto */
      --panel: #121826;
      --muted: #8ea0b5;
      --text: #e7eef8;
      --accent: #4cc2ff;
      --ok: #2fd37a;
      --bad: #ff5d5d;
      --warn: #ffd166;
      --border: #263143;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.45; letter-spacing: .2px;
    }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: linear-gradient(180deg, rgba(11,15,23,.98), rgba(11,15,23,.88)); backdrop-filter: blur(6px); z-index: 10; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    .sub { color: var(--muted); font-size: 13px; }

    .container { max-width: 1200px; margin: 0 auto; padding: 18px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { grid-column: span 12; background: var(--panel); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin: 0; font-size: 16px; padding: 12px 14px; border-bottom: 1px solid var(--border); color: #dbe8f6; }
    .card section, .card .content { padding: 12px 14px; }

    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; align-items: end; }
    .field { grid-column: span 3; display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input, .field select, .field button { height: 36px; border-radius: 10px; border: 1px solid var(--border); background: #0f1522; color: var(--text); padding: 0 10px; outline: none; }
    /* Remover setas do input[type=number] e permitir digitação direta */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .field input::placeholder { color: #7386a3; }
    .field .helper { font-size: 12px; color: var(--muted); }
    /* Inputs dentro das tabelas com o mesmo estilo dos campos de base */
    table input { height: 36px; border: 1px solid var(--border); border-radius: 10px; background: #0f1522; color: var(--text); padding: 0 10px; outline: none; width: 100%; text-align: right; font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .btn { cursor: pointer; transition: transform .05s ease, background .2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(180deg, #2b8fff, #1977e6); border-color: #176ad0; }
    .btn.ghost { background: #0f1522; }
    .btn.warn { background: linear-gradient(180deg, #ff9f1c, #ee8b00); border-color: #e07a00; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: right; white-space: nowrap; }
    th { position: sticky; top: 0; background: #101626; z-index: 1; text-align: right; }
    td:first-child, th:first-child { text-align: left; color: #cfe0f5; }
    tbody tr:hover { background: rgba(255,255,255,.02); }

    /* Destaques das linhas de resumo (YTD / Full Year) */
    tbody tr.summary td { font-weight: 700; border-top: 2px solid var(--border); border-bottom: 2px solid var(--border); }
    tbody tr.summary-ytd { background: rgba(47, 211, 122, 0.12); }
    tbody tr.summary-fy  { background: rgba(76, 194, 255, 0.12); }
    tbody tr.summary td:first-child { color: #ffffff; }

    .muted { color: var(--muted); font-style: italic; }
    .neg { color: var(--bad); font-weight: 600; }
    .pos { color: var(--ok); font-weight: 600; }
    .mono { font-variant-numeric: tabular-nums lining-nums; font-feature-settings: "tnum" 1; }

    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #0f1522; border: 1px solid var(--border); font-size: 12px; color: var(--muted); }

    .footer-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; padding: 10px 14px 16px; border-top: 1px solid var(--border); }

    @media (max-width: 980px) { .field { grid-column: span 6; } }
    @media (max-width: 640px) { .field { grid-column: span 12; } }
  </style>
</head>
<body>
  <header>
    <h1>Painel de Savings 2025</h1>
    <div class="sub">Versão colaborativa (Firebase). Valores negativos em vermelho. <span id="cloudBadge" class="pill" style="margin-left:8px;">Conectando…</span></div>
  </header>

  <div class="container">
    <div class="grid">

      <!-- CONFIG (simplificado) -->
      <div class="card" id="card-config">
        <h2>Configuração de câmbio</h2>
        <section class="row">
          <div class="field" style="grid-column: span 4;">
            <label>BRL por GBP (fixo)</label>
            <input type="number" step="0.0001" id="fxFixed" placeholder="ex.: 7.1415" />
            <div class="helper">Usado para converter BRL → GBP</div>
          </div>
          <div class="field" style="grid-column: span 8;">
            <label>&nbsp;</label>
            <div class="pill">Dica: pode deixar um valor aproximado e ajustar depois.</div>
          </div>
        </section>
        
      </div>

      <!-- TINTA 2025 -->
      <div class="card" id="card-tinta">
        <h2>Redução consumo Tinta — Entradas 2025</h2>
        <section class="row">
          <div class="field" style="grid-column: span 3;">
            <label>Base 2024 — Tinta: Gasto (BRL)</label>
            <input type="number" step="0.01" id="b24_tinta_gasto" placeholder="opcional" />
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>Base 2024 — Tinta: Horas</label>
            <input type="number" step="0.0001" id="b24_tinta_horas" placeholder="opcional" />
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>Base 2024 — Tinta: Custo/h (BRL/h)</label>
            <input type="number" step="0.0001" id="b24_tinta_custoh" placeholder="ex.: 7.9876" />
            <div class="helper">Se preencher gasto + horas, calculamos automático</div>
          </div>
          <div class="field" style="grid-column: span 3; display:flex; justify-content:flex-end;">
            <button class="btn ghost" id="btnBaseSync" title="Grava os parâmetros base na nuvem">Sincronizar base 2024</button>
          </div>
        </section>
        <div class="content">
          <table id="tblTinta" class="mono"></table>
        </div>
      </div>

      <!-- MULTAS 2025 -->
      <div class="card" id="card-multas">
        <h2>Multas — Entradas 2025 (PETROBRAS)</h2>
        <section class="row">
          <div class="field" style="grid-column: span 4;">
            <label>Base 2024 — Multas s/ BOP2 (%)</label>
            <input type="number" step="0.0001" id="b24_multas_pct" placeholder="ex.: 2.9116" />
          </div>
        </section>
        <div class="content">
          <table id="tblMultas" class="mono"></table>
        </div>
      </div>

      <!-- GARANTIAS 2025 -->
      <div class="card" id="card-garantias">
        <h2>Garantias Concedidas — Entradas 2025</h2>
        <section class="row">
          <div class="field" style="grid-column: span 4;">
            <label>Base 2024 — Garantias/Faturamento (%)</label>
            <input type="number" step="0.0001" id="b24_garantias_pct" placeholder="ex.: 0.7593" />
          </div>
        </section>
        <div class="content">
          <table id="tblGarantias" class="mono"></table>
        </div>
      </div>

      <!-- SCRAPS 2025 -->
      <div class="card" id="card-scraps">
        <h2>Scraps — Entradas 2025</h2>
        <div class="content">
          <table id="tblScraps" class="mono"></table>
        </div>
      </div>

      <!-- PROJEÇÕES 2025 -->
      <div class="card" id="card-proj">
        <h2>Projeções — Geral 2025</h2>
        <div class="content">
          <table id="tblProj" class="mono"></table>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
  // ==== Firebase (multiusuário em tempo real) ====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, enableIndexedDbPersistence, deleteField } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAs8atf2cCoes6dXC0ILlsnWiscEO0zoUA",
    authDomain: "savings-521b5.firebaseapp.com",
    projectId: "savings-521b5",
    storageBucket: "savings-521b5.firebasestorage.app",
    messagingSenderId: "926338615773",
    appId: "1:926338615773:web:014ac1b57cb7cb6a440e34"
  };

  let db = null; let auth = null; let currentUser = null;
  const cloud = { enabled: false };
  const debounces = {};
  const syncedProj = {};
  let isEditing = false;
  let needsRender = false;
  function renderSoon(){ if (isEditing) { needsRender = true; } else { buildSectionTables(); } }

  function updateCloudStatus(connected, msg = "") {
    const el = document.getElementById('cloudBadge');
    if (!el) return;
    if (connected) { el.textContent = 'Conectado'; el.style.borderColor = 'var(--ok)'; el.style.color = 'var(--ok)'; }
    else { el.textContent = 'Offline' + (msg ? ' • ' + msg : ''); el.style.borderColor = 'var(--border)'; el.style.color = 'var(--muted)'; }
  }

  async function initCloud() {
    try {
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      try { await signInAnonymously(auth); } catch (e) { /* se anônimo não estiver habilitado, segue sem auth */ }
      onAuthStateChanged(auth, (u) => { currentUser = u; });
      db = getFirestore(app);
      try { await enableIndexedDbPersistence(db); } catch (e) { /* ok sem persistência */ }
      cloud.enabled = true;
      updateCloudStatus(true);
      if (typeof setupRealtime === 'function') setupRealtime();
    } catch (e) { console.warn('Falha ao iniciar Firebase', e); updateCloudStatus(false, 'verifique Providers/Regras'); }
  }

  function docConfig() { return doc(db, 'savings', '2025', 'config', 'base'); }
  function docBase() { return doc(db, 'savings', '2025', 'base2024', 'base'); }
  function docMonth(coll, m) { return doc(db, 'savings', '2025', coll, m); }

  function queueWrite(key, refFactory, patch) {
    if (!cloud.enabled || !db) return;
    clearTimeout(debounces[key]);

    // Normaliza: se valor vier null/"", apagamos o campo no Firestore
    const norm = {};
    Object.keys(patch || {}).forEach(k => {
      const v = patch[k];
      if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
        // objetos (ex.: base.tinta) mantemos como estão
        norm[k] = v;
      } else {
        norm[k] = (v === null || v === '') ? deleteField() : v;
      }
    });

    debounces[key] = setTimeout(async () => {
      try {
        await setDoc(
          refFactory(),
          { ...norm, lastEditedAt: serverTimestamp(), lastEditedBy: currentUser?.uid || 'anon' },
          { merge: true }
        );
      } catch (e) {
        console.warn('Falha ao salvar', key, e);
      }
    }, 350);
  }
  function queueConfig(patch) { queueWrite('config', docConfig, patch); }
  function queueBase(patch) { queueWrite('base', docBase, patch); }
  function queueMonthly(coll, m, patch) { queueWrite(`${coll}/${m}`, () => docMonth(coll, m), patch); }

  // =====================
  // Helpers / Formatação
  // =====================
  const br = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  const gbp = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' });
  function isNum(n) { return typeof n === 'number' && Number.isFinite(n); }
  function num(v) {
    if (v === null || v === undefined) return null;
    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
    let s = String(v).trim(); if (s === '') return null;
    s = s.replace(/[^0-9,\.\-]/g, ''); if (s.includes(',')) { s = s.replace(/\./g, '').replace(',', '.'); }
    const n = Number(s); return Number.isFinite(n) ? n : null;
  }
  function fmtBRL(n) { return isNum(n) ? br.format(n) : '—'; }
  function fmtGBP(n) { return isNum(n) ? gbp.format(n) : '—'; }
  function fxFor(monthKey) { const m = num(state.fxMonthly[monthKey]); if (isNum(m) && m > 0) return m; const f = num(state.config.fxFixed); return isNum(f) && f > 0 ? f : null; }
  function toGBP(brl, monthKey) { const fx = fxFor(monthKey); if (!isNum(brl) || !isNum(fx) || fx <= 0) return null; return brl / fx; }
  function eqMoney(a, b) { return isNum(a) && isNum(b) ? Math.abs(a - b) < 0.005 : false; }
  function maybeSyncProjection(mKey, field, value) { if (!isNum(value)) return; if (!syncedProj[mKey]) syncedProj[mKey] = {}; if (eqMoney(syncedProj[mKey][field], value) || eqMoney(num(state.data2025[mKey]?.prev?.[field]), value)) return; syncedProj[mKey][field] = value; queueMonthly('projecoes', mKey, { [field]: value }); }
  function autoSaveAndRender(){ save(); renderSoon(); }
  function attachFocusBlur(el){ if(!el) return; el.addEventListener('focus', ()=>{ isEditing = true; }); el.addEventListener('blur', ()=>{ isEditing = false; if(needsRender){ needsRender=false; buildSectionTables(); } }); }

  const months = [
    { key: 'jan', label: 'Jan' }, { key: 'fev', label: 'Fev' }, { key: 'mar', label: 'Mar' },
    { key: 'abr', label: 'Abr' }, { key: 'mai', label: 'Mai' }, { key: 'jun', label: 'Jun' },
    { key: 'jul', label: 'Jul' }, { key: 'ago', label: 'Ago' }, { key: 'set', label: 'Set' },
    { key: 'out', label: 'Out' }, { key: 'nov', label: 'Nov' }, { key: 'dez', label: 'Dez' }
  ];

  const STORAGE_KEY = 'savingsAppV1';
  const state = {
    config: { fxFixed: 7.1415 },
    fxMonthly: Object.fromEntries(months.map(m => [m.key, ''])),
    base2024: {
      tinta: { gasto: '', horas: '', custoh: '' },
      multas_pct: '',
      garantias_pct: ''
    },
    data2025: Object.fromEntries(months.map(m => [m.key, {
      tinta: { gasto: '', horas: '' },
      multas: { valor: '', bop2: '' },
      garantias: { garantia: '', faturamento: '' },
      scraps: { valor: '' },
      prev: { tinta:'', multas:'', garantias:'', scraps:'' }
    }]))
  };

  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load() { const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return; try { const obj = JSON.parse(raw); deepMerge(state, obj); } catch {} }
  function deepMerge(target, src) { for (const k in src) { if (src[k] && typeof src[k] === 'object' && !Array.isArray(src[k])) { if (!target[k] || typeof target[k] !== 'object') target[k] = {}; deepMerge(target[k], src[k]); } else { target[k] = src[k]; } } }

  // ==============
  // Construção UI
  // ==============
  const elFxFixed = document.getElementById('fxFixed');
  const elB24_gasto = document.getElementById('b24_tinta_gasto');
  const elB24_horas = document.getElementById('b24_tinta_horas');
  const elB24_custoh = document.getElementById('b24_tinta_custoh');
  const elB24_multas = document.getElementById('b24_multas_pct');
  const elB24_garantias = document.getElementById('b24_garantias_pct');

  const tblTinta = document.getElementById('tblTinta');
  const tblMultas = document.getElementById('tblMultas');
  const tblGarantias = document.getElementById('tblGarantias');
  const tblScraps = document.getElementById('tblScraps');
  const tblProj = document.getElementById('tblProj');

  
  const btnBaseSync = document.getElementById('btnBaseSync');

  // ==================
  // Cálculos por área
  // ==================
  function baseCustoH2024() {
    const g = num(state.base2024.tinta.gasto);
    const h = num(state.base2024.tinta.horas);
    const c = num(state.base2024.tinta.custoh);
    if (isNum(g) && isNum(h) && h > 0) return g / h;
    if (isNum(c) && c > 0) return c;
    return null;
  }
  function baseMultasPct2024() { const p = num(state.base2024.multas_pct); if (!isNum(p) || p <= 0) return null; return p / 100; }
  function baseGarantiasPct2024() { const p = num(state.base2024.garantias_pct); if (!isNum(p) || p <= 0) return null; return p / 100; }

  function calcTintaCustoH(mKey) { const g = num(state.data2025[mKey].tinta.gasto); const h = num(state.data2025[mKey].tinta.horas); if (isNum(g) && isNum(h) && h > 0) return g / h; return null; }
  function calcSavingTinta(mKey) { const custoH25 = calcTintaCustoH(mKey); const baseH = baseCustoH2024(); const horas = num(state.data2025[mKey].tinta.horas); if (!isNum(custoH25) || !isNum(baseH) || !isNum(horas)) return null; return (custoH25 - baseH) * horas * -1; }
  function calcSavingMultas(mKey) { const multa = num(state.data2025[mKey].multas.valor); const bop2 = num(state.data2025[mKey].multas.bop2); const pctBase = baseMultasPct2024(); if (!isNum(multa) || !isNum(bop2) || !isNum(pctBase)) return null; return (multa - bop2 * pctBase) * -1; }
  function calcPctGarantias2025(mKey) { const gar = num(state.data2025[mKey].garantias.garantia); const fat = num(state.data2025[mKey].garantias.faturamento); if (!isNum(gar) || !isNum(fat) || fat <= 0) return null; return gar / fat; }
  function calcSavingGarantias(mKey) { const pctBase = baseGarantiasPct2024(); const fat = num(state.data2025[mKey].garantias.faturamento); const pct25 = calcPctGarantias2025(mKey); if (!isNum(pctBase) || !isNum(fat) || !isNum(pct25)) return null; return (pctBase - pct25) * fat; }

  // --- Realtime do Firestore ---
  function setupRealtime() {
    if (!db) return;
    // CONFIG
    try { onSnapshot(docConfig(), (snap) => { const d = snap.data() || {}; if (d.fxFixed !== undefined) { state.config.fxFixed = d.fxFixed; if (elFxFixed) elFxFixed.value = d.fxFixed ?? ''; } if (d.fxMonthly) { Object.assign(state.fxMonthly, d.fxMonthly); } save(); renderSoon(); }); } catch (e) { console.warn('onSnapshot config', e); }
    // BASE 2024
    try { onSnapshot(docBase(), (snap) => { const d = snap.data() || {}; if (d.tinta) { state.base2024.tinta.gasto = d.tinta.gasto ?? ''; state.base2024.tinta.horas = d.tinta.horas ?? ''; state.base2024.tinta.custoh = d.tinta.custoh ?? ''; if (elB24_gasto) elB24_gasto.value = state.base2024.tinta.gasto ?? ''; if (elB24_horas) elB24_horas.value = state.base2024.tinta.horas ?? ''; if (elB24_custoh) elB24_custoh.value = state.base2024.tinta.custoh ?? ''; } if (d.multas_pct !== undefined) { state.base2024.multas_pct = d.multas_pct ?? ''; if (elB24_multas) elB24_multas.value = state.base2024.multas_pct ?? ''; } if (d.garantias_pct !== undefined) { state.base2024.garantias_pct = d.garantias_pct ?? ''; if (elB24_garantias) elB24_garantias.value = state.base2024.garantias_pct ?? ''; } save(); renderSoon(); }); } catch (e) { console.warn('onSnapshot base', e); }
    // DADOS MENSAIS
    months.forEach(m => {
      try {
        onSnapshot(docMonth('tinta', m.key), (snap) => {
        const d = snap.data() || {};
        if (!state.data2025[m.key].tinta) state.data2025[m.key].tinta = {};
        state.data2025[m.key].tinta.gasto = ('gasto' in d) ? (d.gasto ?? '') : '';
        state.data2025[m.key].tinta.horas = ('horas' in d) ? (d.horas ?? '') : '';
        save(); buildSectionTables();
      });
        onSnapshot(docMonth('multas', m.key), (snap) => {
        const d = snap.data() || {};
        if (!state.data2025[m.key].multas) state.data2025[m.key].multas = {};
        state.data2025[m.key].multas.valor = ('valor' in d) ? (d.valor ?? '') : '';
        state.data2025[m.key].multas.bop2  = ('bop2'  in d) ? (d.bop2  ?? '') : '';
        save(); buildSectionTables();
      });
        onSnapshot(docMonth('garantias', m.key), (snap) => {
        const d = snap.data() || {};
        if (!state.data2025[m.key].garantias) state.data2025[m.key].garantias = {};
        state.data2025[m.key].garantias.garantia    = ('garantia' in d) ? (d.garantia ?? '') : '';
        state.data2025[m.key].garantias.faturamento = ('faturamento' in d) ? (d.faturamento ?? '') : '';
        save(); buildSectionTables();
      });
        onSnapshot(docMonth('scraps', m.key), (snap) => {
        const d = snap.data() || {};
        if (!state.data2025[m.key].scraps) state.data2025[m.key].scraps = {};
        state.data2025[m.key].scraps.valor = ('valor' in d) ? (d.valor ?? '') : '';
        save(); buildSectionTables();
      });
        onSnapshot(docMonth('projecoes', m.key), (snap) => {
        const d = snap.data() || {};
        if (!state.data2025[m.key].prev) state.data2025[m.key].prev = { tinta:'',multas:'',garantias:'',scraps:'' };
        state.data2025[m.key].prev.tinta     = ('tinta'     in d) ? (d.tinta     ?? '') : '';
        state.data2025[m.key].prev.multas    = ('multas'    in d) ? (d.multas    ?? '') : '';
        state.data2025[m.key].prev.garantias = ('garantias' in d) ? (d.garantias ?? '') : '';
        state.data2025[m.key].prev.scraps    = ('scraps'    in d) ? (d.scraps    ?? '') : '';
        save(); buildSectionTables();
      });
      } catch (e) { console.warn('onSnapshot mes', m.key, e); }
    });
  }

  // =========
  // Tabelas
  // =========
  function setSavingCell(td, value, isGBP = false) { if (!isNum(value)) { td.textContent = 'futuro'; td.className = 'muted'; return; } const isNeg = value < 0; td.className = isNeg ? 'neg' : 'pos'; td.textContent = isGBP ? fmtGBP(value) : fmtBRL(value); }
  function inpNum(current, onChange) {
    const inp = document.createElement('input');
    inp.type = 'number'; inp.step = 'any'; inp.inputMode = 'decimal'; inp.autocomplete = 'off';
    inp.value = current ?? '';
    inp.addEventListener('focus', () => { isEditing = true; });
    const commit = () => {
      onChange(inp.value);
      save();
      isEditing = false;
      buildSectionTables();
      if (needsRender) { needsRender = false; }
    };
    inp.addEventListener('change', commit);
    inp.addEventListener('blur', commit);
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { commit(); inp.blur(); } });
    return inp;
  }
  function inpMoney(current, onChange) {
    const inp = document.createElement('input');
    inp.type = 'text'; inp.inputMode = 'decimal'; inp.autocomplete = 'off';
    const n = num(current); inp.value = isNum(n) ? br.format(n) : (current ?? '');
    inp.addEventListener('focus', () => { isEditing = true; });
    const commit = () => {
      const parsed = num(inp.value);
      onChange(parsed, inp.value);
      inp.value = isNum(parsed) ? br.format(parsed) : '';
      save();
      isEditing = false;
      buildSectionTables();
      if (needsRender) { needsRender = false; }
    };
    inp.addEventListener('change', commit);
    inp.addEventListener('blur', commit);
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { commit(); inp.blur(); } });
    return inp;
  }

  function buildSectionTables() {
    // TINTA
    tblTinta.innerHTML = '';
    const tHeadTinta = `<thead><tr><th>Mês</th><th>Gasto (BRL)</th><th>Horas</th><th>Custo/h 2025</th><th>Saving (BRL)</th><th>Total (GBP)</th></tr></thead>`; tblTinta.insertAdjacentHTML('beforeend', tHeadTinta);
    const tbT = document.createElement('tbody');
    months.forEach(m => { const row = document.createElement('tr'); const cMes = document.createElement('td'); cMes.textContent = m.label; row.appendChild(cMes); const cG = document.createElement('td'); const iG = inpMoney(state.data2025[m.key].tinta.gasto, (valNum, raw) => { state.data2025[m.key].tinta.gasto = raw; queueMonthly('tinta', m.key, { gasto: valNum }); }); cG.appendChild(iG); row.appendChild(cG); const cH = document.createElement('td'); const iH = inpNum(state.data2025[m.key].tinta.horas, (v) => { state.data2025[m.key].tinta.horas = v; queueMonthly('tinta', m.key, { horas: num(v) }); }); cH.appendChild(iH); row.appendChild(cH); const custoH = calcTintaCustoH(m.key); const cCH = document.createElement('td'); cCH.textContent = isNum(custoH) ? fmtBRL(custoH) : 'futuro'; cCH.className = isNum(custoH) ? '' : 'muted'; row.appendChild(cCH); const sv = calcSavingTinta(m.key); const cSV = document.createElement('td'); setSavingCell(cSV, sv); row.appendChild(cSV); const cGBP = document.createElement('td'); const gb = toGBP(sv, m.key); setSavingCell(cGBP, gb, true); row.appendChild(cGBP); tbT.appendChild(row); });
    tblTinta.appendChild(tbT);

    // MULTAS
    tblMultas.innerHTML = '';
    const tHeadMultas = `<thead><tr><th>Mês</th><th>Multas pagas (BRL)</th><th>BOP2 (BRL)</th><th>Saving (BRL)</th><th>Total (GBP)</th></tr></thead>`; tblMultas.insertAdjacentHTML('beforeend', tHeadMultas);
    const tbM = document.createElement('tbody');
    months.forEach(m => { const row = document.createElement('tr'); const cMes = document.createElement('td'); cMes.textContent = m.label; row.appendChild(cMes); const cMul = document.createElement('td'); const iMul = inpMoney(state.data2025[m.key].multas.valor, (valNum, raw) => { state.data2025[m.key].multas.valor = raw; queueMonthly('multas', m.key, { valor: valNum }); }); cMul.appendChild(iMul); row.appendChild(cMul); const cBop = document.createElement('td'); const iBop = inpMoney(state.data2025[m.key].multas.bop2, (valNum, raw) => { state.data2025[m.key].multas.bop2 = raw; queueMonthly('multas', m.key, { bop2: valNum }); }); cBop.appendChild(iBop); row.appendChild(cBop); const sv = calcSavingMultas(m.key); const cSV = document.createElement('td'); setSavingCell(cSV, sv); row.appendChild(cSV); const cGBP = document.createElement('td'); const gb = toGBP(sv, m.key); setSavingCell(cGBP, gb, true); row.appendChild(cGBP); tbM.appendChild(row); });
    tblMultas.appendChild(tbM);

    // GARANTIAS
    tblGarantias.innerHTML = '';
    const tHeadGar = `<thead><tr><th>Mês</th><th>Garantias (BRL)</th><th>Faturamento (BRL)</th><th>% 2025</th><th>Saving (BRL)</th><th>Total (GBP)</th></tr></thead>`; tblGarantias.insertAdjacentHTML('beforeend', tHeadGar);
    const tbG = document.createElement('tbody');
    months.forEach(m => { const row = document.createElement('tr'); const cMes = document.createElement('td'); cMes.textContent = m.label; row.appendChild(cMes); const cGa = document.createElement('td'); const iGa = inpMoney(state.data2025[m.key].garantias.garantia, (valNum, raw) => { state.data2025[m.key].garantias.garantia = raw; queueMonthly('garantias', m.key, { garantia: valNum }); }); cGa.appendChild(iGa); row.appendChild(cGa); const cFat = document.createElement('td'); const iFat = inpMoney(state.data2025[m.key].garantias.faturamento, (valNum, raw) => { state.data2025[m.key].garantias.faturamento = raw; queueMonthly('garantias', m.key, { faturamento: valNum }); }); cFat.appendChild(iFat); row.appendChild(cFat); const pct = calcPctGarantias2025(m.key); const cPct = document.createElement('td'); cPct.textContent = isNum(pct) ? (pct*100).toFixed(4)+'%' : 'futuro'; cPct.className = isNum(pct) ? '' : 'muted'; row.appendChild(cPct); const sv = calcSavingGarantias(m.key); const cSV = document.createElement('td'); setSavingCell(cSV, sv); row.appendChild(cSV); const cGBP = document.createElement('td'); const gb = toGBP(sv, m.key); setSavingCell(cGBP, gb, true); row.appendChild(cGBP); tbG.appendChild(row); });
    tblGarantias.appendChild(tbG);

    // SCRAPS
    tblScraps.innerHTML = '';
    const tHeadScr = `<thead><tr><th>Mês</th><th>Valor (BRL)</th><th>Total (GBP)</th></tr></thead>`; tblScraps.insertAdjacentHTML('beforeend', tHeadScr);
    const tbS = document.createElement('tbody');
    months.forEach(m => { const row = document.createElement('tr'); const cMes = document.createElement('td'); cMes.textContent = m.label; row.appendChild(cMes); const cVal = document.createElement('td'); const iVal = inpMoney(state.data2025[m.key].scraps.valor, (valNum, raw) => { state.data2025[m.key].scraps.valor = raw; queueMonthly('scraps', m.key, { valor: valNum }); }); cVal.appendChild(iVal); row.appendChild(cVal); const cGBP = document.createElement('td'); const gb = toGBP(num(state.data2025[m.key].scraps.valor), m.key); setSavingCell(cGBP, gb, true); row.appendChild(cGBP); tbS.appendChild(row); });
    tblScraps.appendChild(tbS);

    // PROJEÇÕES (mostra real quando existe, e campo de projeção quando não)
    tblProj.innerHTML = '';
    const tHeadProj = `<thead><tr><th>Mês</th><th>Tinta Prev./Real (BRL)</th><th>Multas Prev./Real (BRL)</th><th>Garantias Prev./Real (BRL)</th><th>Scraps Prev./Real (BRL)</th><th>Total (BRL)</th><th>Total (GBP)</th></tr></thead>`; tblProj.insertAdjacentHTML('beforeend', tHeadProj);
    const tbP = document.createElement('tbody');
    let ytd = { t:0, mu:0, ga:0, sc:0, totalBRL:0, totalGBP:0 }; let fy  = { t:0, mu:0, ga:0, sc:0, totalBRL:0, totalGBP:0 };
    months.forEach(m => {
      if (!state.data2025[m.key].prev) state.data2025[m.key].prev = { tinta:'',multas:'',garantias:'',scraps:'' };
      const row = document.createElement('tr');
      const cMes = document.createElement('td'); cMes.textContent = m.label; row.appendChild(cMes);

      const realT = calcSavingTinta(m.key); const realMu = calcSavingMultas(m.key); const realGa = calcSavingGarantias(m.key); const realSc = num(state.data2025[m.key].scraps.valor);

      const cT = document.createElement('td'); if (isNum(realT)) { setSavingCell(cT, realT); const badge = document.createElement('span'); badge.className = 'pill'; badge.style.marginLeft = '6px'; badge.textContent = 'real'; cT.appendChild(badge); maybeSyncProjection(m.key, 'tinta', realT); } else { const iT = inpMoney(state.data2025[m.key].prev.tinta, (valNum, raw) => { state.data2025[m.key].prev.tinta = raw; queueMonthly('projecoes', m.key, { tinta: valNum }); }); cT.appendChild(iT); } row.appendChild(cT);
      const cM = document.createElement('td'); if (isNum(realMu)) { setSavingCell(cM, realMu); const badge = document.createElement('span'); badge.className = 'pill'; badge.style.marginLeft = '6px'; badge.textContent = 'real'; cM.appendChild(badge); maybeSyncProjection(m.key, 'multas', realMu); } else { const iM = inpMoney(state.data2025[m.key].prev.multas, (valNum, raw) => { state.data2025[m.key].prev.multas = raw; queueMonthly('projecoes', m.key, { multas: valNum }); }); cM.appendChild(iM); } row.appendChild(cM);
      const cG = document.createElement('td'); if (isNum(realGa)) { setSavingCell(cG, realGa); const badge = document.createElement('span'); badge.className = 'pill'; badge.style.marginLeft = '6px'; badge.textContent = 'real'; cG.appendChild(badge); maybeSyncProjection(m.key, 'garantias', realGa); } else { const iG = inpMoney(state.data2025[m.key].prev.garantias, (valNum, raw) => { state.data2025[m.key].prev.garantias = raw; queueMonthly('projecoes', m.key, { garantias: valNum }); }); cG.appendChild(iG); } row.appendChild(cG);
      const cS = document.createElement('td'); if (isNum(realSc)) { setSavingCell(cS, realSc); const badge = document.createElement('span'); badge.className = 'pill'; badge.style.marginLeft = '6px'; badge.textContent = 'real'; cS.appendChild(badge); maybeSyncProjection(m.key, 'scraps', realSc); } else { const iS = inpMoney(state.data2025[m.key].prev.scraps, (valNum, raw) => { state.data2025[m.key].prev.scraps = raw; queueMonthly('projecoes', m.key, { scraps: valNum }); }); cS.appendChild(iS); } row.appendChild(cS);

      const vT = isNum(realT) ? realT : num(state.data2025[m.key].prev.tinta);
      const vMu = isNum(realMu) ? realMu : num(state.data2025[m.key].prev.multas);
      const vGa = isNum(realGa) ? realGa : num(state.data2025[m.key].prev.garantias);
      const vSc = isNum(realSc) ? realSc : num(state.data2025[m.key].prev.scraps);

      const totFY = [vT, vMu, vGa, vSc].filter(isNum).reduce((a,b)=>a+b,0);
      const cTot = document.createElement('td'); setSavingCell(cTot, isNum(totFY) ? totFY : null); row.appendChild(cTot);
      if (isNum(totFY)) fy.totalBRL += totFY;
      const totFYGBP = toGBP(isNum(totFY) ? totFY : null, m.key);
      const cTotG = document.createElement('td'); setSavingCell(cTotG, totFYGBP, true); row.appendChild(cTotG);
      if (isNum(totFYGBP)) fy.totalGBP += totFYGBP;

      const totReal = [realT, realMu, realGa, realSc].filter(isNum).reduce((a,b)=>a+b,0);
      if (isNum(realT)) ytd.t += realT; if (isNum(realMu)) ytd.mu += realMu; if (isNum(realGa)) ytd.ga += realGa; if (isNum(realSc)) ytd.sc += realSc;
      if (isNum(totReal)) { ytd.totalBRL += totReal; const totRealGBP = toGBP(totReal, m.key); if (isNum(totRealGBP)) ytd.totalGBP += totRealGBP; }

      if (isNum(vT)) fy.t += vT; if (isNum(vMu)) fy.mu += vMu; if (isNum(vGa)) fy.ga += vGa; if (isNum(vSc)) fy.sc += vSc;

      tbP.appendChild(row);
    });

    // Linhas de resumo (YTD e Full Year)
    const trYTD = document.createElement('tr'); trYTD.className = 'summary summary-ytd';
    const tdYLab = document.createElement('td'); tdYLab.textContent = 'YTD (Real)'; trYTD.appendChild(tdYLab);
    const tdYT = document.createElement('td'); tdYT.textContent = fmtBRL(ytd.t); tdYT.className = ytd.t < 0 ? 'neg' : 'pos'; trYTD.appendChild(tdYT);
    const tdYMu = document.createElement('td'); tdYMu.textContent = fmtBRL(ytd.mu); tdYMu.className = ytd.mu < 0 ? 'neg' : 'pos'; trYTD.appendChild(tdYMu);
    const tdYGa = document.createElement('td'); tdYGa.textContent = fmtBRL(ytd.ga); tdYGa.className = ytd.ga < 0 ? 'neg' : 'pos'; trYTD.appendChild(tdYGa);
    const tdYSc = document.createElement('td'); tdYSc.textContent = fmtBRL(ytd.sc); tdYSc.className = ytd.sc < 0 ? 'neg' : 'pos'; trYTD.appendChild(tdYSc);
    const tdYTot = document.createElement('td'); tdYTot.textContent = fmtBRL(ytd.totalBRL); tdYTot.className = ytd.totalBRL < 0 ? 'neg' : 'pos'; trYTD.appendChild(tdYTot);
    const tdYTotG = document.createElement('td'); tdYTotG.textContent = fmtGBP(ytd.totalGBP); tdYTotG.className = (ytd.totalGBP < 0 ? 'neg' : 'pos'); trYTD.appendChild(tdYTotG);
    tbP.appendChild(trYTD);

    const trFY = document.createElement('tr'); trFY.className = 'summary summary-fy';
    const tdFLab = document.createElement('td'); tdFLab.textContent = 'Full Year (Proj.)'; trFY.appendChild(tdFLab);
    const tdFT = document.createElement('td'); tdFT.textContent = fmtBRL(fy.t); tdFT.className = fy.t < 0 ? 'neg' : 'pos'; trFY.appendChild(tdFT);
    const tdFMu = document.createElement('td'); tdFMu.textContent = fmtBRL(fy.mu); tdFMu.className = fy.mu < 0 ? 'neg' : 'pos'; trFY.appendChild(tdFMu);
    const tdFGa = document.createElement('td'); tdFGa.textContent = fmtBRL(fy.ga); tdFGa.className = fy.ga < 0 ? 'neg' : 'pos'; trFY.appendChild(tdFGa);
    const tdFSc = document.createElement('td'); tdFSc.textContent = fmtBRL(fy.sc); tdFSc.className = fy.sc < 0 ? 'neg' : 'pos'; trFY.appendChild(tdFSc);
    const tdFTot = document.createElement('td'); tdFTot.textContent = fmtBRL(fy.totalBRL); tdFTot.className = fy.totalBRL < 0 ? 'neg' : 'pos'; trFY.appendChild(tdFTot);
    const tdFTotG = document.createElement('td'); tdFTotG.textContent = fmtGBP(fy.totalGBP); tdFTotG.className = (fy.totalGBP < 0 ? 'neg' : 'pos'); trFY.appendChild(tdFTotG);
    tbP.appendChild(trFY);

    tblProj.appendChild(tbP);
  }

  // ============================
  // Interações / Bind de inputs
  // ============================
  function bindInputs() {
    // FX fixo
    elFxFixed.value = state.config.fxFixed ?? '';
    attachFocusBlur(elFxFixed);
    elFxFixed.addEventListener('input', () => {
      state.config.fxFixed = elFxFixed.value;
      save();
      queueConfig({ fxFixed: num(elFxFixed.value) });
      renderSoon();
    });

    // Parâmetros Base 2024 (cada card)
    elB24_gasto.value = state.base2024.tinta.gasto ?? '';
    elB24_horas.value = state.base2024.tinta.horas ?? '';
    elB24_custoh.value = state.base2024.tinta.custoh ?? '';
    elB24_multas.value = state.base2024.multas_pct ?? '';
    elB24_garantias.value = state.base2024.garantias_pct ?? '';

    [elB24_gasto, elB24_horas, elB24_custoh, elB24_multas, elB24_garantias].forEach(attachFocusBlur);

    [elB24_gasto, elB24_horas, elB24_custoh].forEach(el => el.addEventListener('input', () => {
      state.base2024.tinta.gasto = elB24_gasto.value;
      state.base2024.tinta.horas = elB24_horas.value;
      state.base2024.tinta.custoh = elB24_custoh.value;
      save();
      queueBase({ tinta: { gasto: num(elB24_gasto.value), horas: num(elB24_horas.value), custoh: num(elB24_custoh.value) } });
      renderSoon();
    }));

    elB24_multas.addEventListener('input', () => {
      state.base2024.multas_pct = elB24_multas.value;
      save();
      queueBase({ multas_pct: num(elB24_multas.value) });
      renderSoon();
    });
    elB24_garantias.addEventListener('input', () => {
      state.base2024.garantias_pct = elB24_garantias.value;
      save();
      queueBase({ garantias_pct: num(elB24_garantias.value) });
      renderSoon();
    });

    if (btnBaseSync) btnBaseSync.addEventListener('click', () => {
      queueBase({
        tinta: { gasto: num(state.base2024.tinta.gasto), horas: num(state.base2024.tinta.horas), custoh: num(state.base2024.tinta.custoh) },
        multas_pct: num(state.base2024.multas_pct),
        garantias_pct: num(state.base2024.garantias_pct)
      });
      alert('Base 2024 sincronizada com a nuvem.');
    });
  }

  // Bootstrap
  load();
  months.forEach(m => { const k = m.key; if (!state.data2025[k]) state.data2025[k] = {}; if (!state.data2025[k].prev) state.data2025[k].prev = { tinta:'',multas:'',garantias:'',scraps:'' }; });
  bindInputs();
  buildSectionTables();
  initCloud();
  </script>
</body>
</html>
